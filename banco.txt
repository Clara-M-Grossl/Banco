#include <iostream>
#include <string>
#include <sstream>
#include <vector>
#include <cctype>
#include <cstring>
#include <ctime>
#include <cstdlib>
#include <fstream>

using namespace std;

//clietn.hpp
class Client{
    private:
        string name;
        string address;
        string job;
        float income;
    public:
        Client(string name, string address, string job, float income);
        void Update(string name, string address, string job, float income);

        string GetName();
        string GetAddress();
        string GetJob();
        float GetIncome();
        string GetInformation();
        string GetInformationSimple();
};

class Account{
    private:
        Client *_client;
        float balance;
    public:
        Account(Client *client, float balance);
        ~Account();

        void UpdateClient(Client *client);
        bool Deposit(float value);
        bool Withdraw(float value);
        bool Transfer(Account &account, float value);

        string GetClientInformation();
        string GetClientInformationSimple();
        float GetBalance();
};


//functions.hpp
Client CadastrarCliente();
Account CadastrarConta(int i, vector<Client> &clients);
int SearchSubstring(string substring, vector<Client> &clients);
void MostrarClientes(vector<Client> &clients, int i);
void MostrarContas(int i, vector<Account> &accounts);

bool DeleteClient(int i, vector<Client> &clients);

void ImportarDadosContas(vector<Account> &accounts, string name1);
void ImportarDadosClientes(vector<Client> &clients, string name1);
void ExportarDadosContas(vector<Account> &accounts, string name);
void ExportarDadosClientes(vector<Client> &clients, string name);

int main(){
    int opc;
    vector<Client> clients;
    vector<Account> accounts;

    cout << "IMPORTANDO DADOS" << endl;

    ImportarDadosContas(accounts, "accounts.txt");
    ImportarDadosClientes(clients, "clients.txt");

    for(;;){
        cout << "Escolha uma opcao: " << endl;
        cout << "[1] - Cadastrar cliente" << endl;
        cout << "[2] - Atualizar cliente" << endl;
        cout << "[3] - Remover cliente" << endl;
        cout << "[4] - Pesquisar cliente por substring" << endl;
        cout << "[5] - Criar uma conta" << endl;
        cout << "[6] - Deposito" << endl;
        cout << "[7] - Transferencia" << endl;
        cout << "[8] - Imprimir dados de uma conta" << endl;
        cout << "[0] - Sair" << endl;
        cout << "<< ";
        cin >> opc;

        if(opc == 1){
            Client newClient = CadastrarCliente();
            clients.push_back(newClient);
            continue;
        }
        if(opc == 2){
            string name;
            cin.ignore();
            cout << "Digite o nome desejado......................: ";
            getline(cin, name);

            int i = SearchSubstring(name, clients);
            if(i < 0){
                cout << "cliente nao encontrado" << endl;
                break;
            }
            cout << "cliente encontrado" << endl;
            MostrarClientes(clients, i);
            cout << "Deseja atualizar a (o) cliente " << clients[i].GetName() << "?" << endl;
            cout << "[1] - Sim" << endl << "[2] - Nao" << endl;
            int answer;
            cin >> answer;

            if(answer == 1){
                string nome;
                string job;
                string address;
                float income;

                cin.ignore();

                cout << "Digite o nome........................: ";
                getline(cin, nome);

                cout << "Digite o endereco........................: ";
                getline(cin, address);

                cout << "Digite a profissao........................: ";
                getline(cin, job);

                cout << "Digite a renda........................: ";
                cin >> income;

                clients[i].Update(nome, address, job, income);
                cout << "Cliente atualizado" << endl;
                continue;
            }
            else if(answer == 2){
                cout << "Voltando ao menu principal........................." << endl;
                continue;
            }
            else{
                cout << "opcaoa invalida" << endl;
                continue;
            }
            continue;
        }
        if(opc == 3){
            string name;
            cin.ignore();
            cout << "Digite o nome desejado......................: ";
            getline(cin, name);

            int i = SearchSubstring(name, clients);
            if(i < 0){
                cout << "cliente nao encontrado" << endl;
                break;
            }
            cout << "cliente encontrado" << endl;
            MostrarClientes(clients, i);
            cout << "Deseja deletar a (o) cliente " << clients[i].GetName() << "?" << endl;
            cout << "[1] - Sim" << endl << "[2] - Nao" << endl;
            int answer;
            cin >> answer;

            if(answer == 1){
                if(DeleteClient(i, clients)){
                    continue;
                }else{
                    break;
                }
            }
            else if(answer == 2){
                cout << "Voltando ao menu principal........................." << endl;
                continue;
            }
            else{
                cout << "opcaoa invalida" << endl;
                continue;
            }
            continue;
        }
        if(opc == 4){
            string name;
            cin.ignore();
            cout << "Digite o nome desejado(* para todos)......................: ";
            getline(cin, name);

            if(name == "*"){
                for(int i = 0; i < clients.size(); i++){
                    MostrarClientes(clients, i);
                }
                continue;
            }
            int i = SearchSubstring(name, clients);
            if(i < 0){
                cout << "cliente nao encontrado" << endl;
                continue;
            }
            cout << "cliente encontrado" << endl;
            MostrarClientes(clients, i);
            continue;
        }
        if(opc == 5){
            string name;
            cin.ignore();
            cout << "Digite o nome desejado......................: "; 
            getline(cin, name);

            int i = SearchSubstring(name, clients);
            if(i < 0){
                cout << "cliente nao encontrado" << endl;
                break;
            }
            cout << "cliente encontrado" << endl;
            MostrarClientes(clients, i);
            cout << "Deseja criar uma conta para: " << clients[i].GetName() << "?" << endl;
            cout << "[1] - Sim" << endl << "[2] - Nao" << endl;
            int answer;
            cin >> answer;

            if(answer == 1){
                float balance;

                cout << "Digite o saldo da conta..................: ";
                cin >> balance;

                Account newAccount = Account(&clients[i], balance);
                // Account newAccount = CadastrarConta(i, clients);
                accounts.push_back(newAccount);
            }
            else if(answer == 2){
                cout << "Voltando ao menu principal........................." << endl;
                continue;
            }
            else{
                cout << "opcaoa invalida" << endl;
                continue;
            }
            continue;
        }
        if(opc == 6){
            int index;
            cout << "Digite o indice desejado: ";
            cin >> index;

            if(index >= 0 && index <= accounts.size()){
                MostrarContas(index, accounts);
                float value;

                cout << "Digite o valor do deposito.................: ";
                cin >> value;

                if(accounts[index].Deposit(value)){
                    cout << "Valor depositado" << endl;
                    continue;
                }
                continue;
            }
            cout << "Indice ( " << index << " ) invalido" << endl;
            continue;
        }
        if(opc == 7){
            int index;
            int index_2;
            cout << "Digite o indice desejado: ";
            cin >> index;

            if(index >= 0 && index <= accounts.size()){
                MostrarContas(index, accounts);

                cout << "Digite o indice para transferir: ";
                cin >> index_2;

                if(index_2 >= 0 && index_2 <= accounts.size()){
                    MostrarContas(index_2, accounts);
                    float value;

                    cout << "Digite o valor da transferencia.................: ";
                    cin >> value;

                    if(accounts[index].Transfer(accounts[index_2], value)){
                        cout << "Valor transferidp" << endl;
                        continue;
                    }
                    cout << "valor nao depositado" << endl;
                    continue;
                }
            }
            cout << "Indice ( " << index << " ) invalido" << endl;
            continue;
        }
        if(opc == 8){
            string y;
            cin.ignore();
            cout << "Digite o indice desejado (* para todos): ";
            getline(cin, y);
            
            if(y == "*"){
                for(size_t i = 0; i < accounts.size(); i++){
                    MostrarContas(i, accounts);
                }
            }
            else{
                int index = stoi(y);
                if(index >= 0 && index <= accounts.size()){
                    MostrarContas(index, accounts);
                    continue;
                }
                cout << "Indice ( " << index << " ) invalido" << endl;
                 continue;
            }
            continue;
        }
        if(opc == 0){
            cout << "EXPORTANDO DADOS" << endl;
            ExportarDadosContas(accounts, "accounts.txt");
            ExportarDadosClientes(clients, "clients.txt");
            cout << "Saind.............." << endl;
            break;
        }
        else{
            cout << "invalido" << endl;
            break;
        }
    }
    return 0;
}

//client.cpp

Client::Client(string name, string address, string job, float income){
    this->name = name;
    this->address = address;
    this->job = job;
    this->income = income;
}
void Client::Update(string name, string address, string job, float income){
    this->name = name;
    this->address = address;
    this->job = job;
    this->income = income;
}
string Client::GetName(){
    return this->name;
}
string Client::GetAddress(){
    return this->address;
}
string Client::GetJob(){
    return this->job;
}
float Client::GetIncome(){
    return this->income;
}
string Client::GetInformation()
{
    stringstream stt;
    stt << "Name....................: " << this->name << "\nJob....................: " << this->job << "\nIncome....................: " << this->income;

    return stt.str();
}
string Client::GetInformationSimple(){
    stringstream stt;

    stt << this->name << "\n" << this->address << "\n" << this->job << "\n" << this->income;

    return stt.str();
}

//account.cpp

Account::Account(Client *client, float balance){
    _client = client;
    this->balance = balance;
}
Account::~Account(){

}

void Account::UpdateClient(Client *client){
    _client = client;
}
bool Account::Deposit(float value){
    this->balance += value;
    return true;
}
bool Account::Withdraw(float value){
    if(this->balance >= value){
        this->balance -= value;
        return true;
    }
    return false;
}
bool Account::Transfer(Account &account, float value){
    if(this->balance >= value){
        this->balance -= value;
        account.Deposit(value);
        return true;
    }
    return false;
}

string Account::GetClientInformation(){
    return _client->GetInformation();
}
string Account::GetClientInformationSimple(){
    return _client->GetInformationSimple();
}
float Account::GetBalance(){
    return this->balance;
}


// functions.cpp
Client CadastrarCliente(){
    string name;
    string job;
    string address;
    float income;

    cin.ignore();

    cout << "Digite o nome........................: ";
    getline(cin, name);

    cout << "Digite o endereco........................: ";
    getline(cin, address);

    cout << "Digite a profissao........................: ";
    getline(cin, job);

    cout << "Digite a renda........................: ";
    cin >> income;

    Client newClient(name, address, job, income);
    return newClient;
}

Account CadastrarConta(int i, vector<Client> &clients){
    float balance;

    cout << "Digite o saldo da conta..................: ";
    cin >> balance;

    Account newAccount = Account(&clients[i], balance);

    return newAccount;
}

int SearchSubstring(string substring, vector<Client> &clients){
    for(size_t i = 0; i < clients.size(); i ++){
        if(clients[i].GetName().find(substring) != string::npos){
            return i;
        }
    }
    return -1;
}

void MostrarClientes(vector<Client> &clients, int i){
    cout << "=================================================================================" << endl;
    cout << "Cliente ID: " << i << endl;
    cout << "Nome...................................: " << clients[i].GetName() << endl;
    cout << "Endereco...............................: " << clients[i].GetAddress() << endl;
    cout << "Profissao..............................: " << clients[i].GetJob() << endl;
    cout << "Renda..................................: " << clients[i].GetIncome() << endl;

    cout << "=================================================================================" << endl;
}

bool DeleteClient(int i, vector<Client> &clients){
    if (i >= 0 && i < clients.size()){
        cout << "Cliente (" << "nome: " << clients[i].GetName() << ") deletada(o)" << endl;
        clients.erase(clients.begin() + i);
        return true;
    }
    else{
        cout << "Indice (" << i << ") nao pertence ao intervalo" << endl;
        return false;
    }
}

void MostrarContas(int i, vector<Account> &accounts){
    cout << "=================================================================================" << endl;
    cout << "Conta ID..............................: " << i << endl;
    cout << "Cliente...............................: " << endl  << accounts[i].GetClientInformation() << endl;
    cout << "Saldo.................................: " << accounts[i].GetBalance() << endl;
    cout << "=================================================================================" << endl;
}
void ImportarDadosContas(vector<Account> &accounts, string name1){
    ifstream fileptr;
    string name, address, job;
    float balance, income;
    
    fileptr.open(name1);

    if(fileptr.good()){
        while(getline(fileptr, name) && getline(fileptr, address) && getline(fileptr, job) && fileptr >> income && fileptr >> balance){
            fileptr.ignore();
            Client *client = new Client(name, address, job, income);
            Account newAccount(client, balance);
            accounts.push_back(newAccount);
        }
    }
    else{
        cout << "error" << endl;
    }

    fileptr.close();
}
void ImportarDadosClientes(vector<Client> &clients, string name1){
    ifstream fileptr;
    string name, address, job;
    float income;
    
    fileptr.open(name1);

    if(fileptr.good()){
        while(getline(fileptr, name) && getline(fileptr, address) && getline(fileptr, job) && fileptr >> income){
            fileptr.ignore();
            Client newClient(name, address, job, income);
            clients.push_back(newClient);
        }
    }
    else{
        cout << "error" << endl;
    }
    fileptr.close();

}
void ExportarDadosContas(vector<Account> &accounts, string name){
    ofstream fileptr;

    fileptr.open(name);

    if(fileptr.good()){
        for(size_t i = 0; i < accounts.size(); i++){
            fileptr << accounts[i].GetClientInformationSimple() << "\n" << accounts[i].GetBalance() << "\n" ;
        }
    }
    else{
        cout << "error to open file" << endl;
    }
    fileptr.close();
}
void ExportarDadosClientes(vector<Client> &clients, string name){
     ofstream fileptr;

    fileptr.open(name);

    if(fileptr.good()){
        for(size_t i = 0; i < clients.size(); i++){
            fileptr << clients[i].GetName() << "\n" << clients[i].GetAddress() << "\n" << clients[i].GetJob() << "\n" << clients[i].GetIncome() << "\n" ;
        }
    }
    else{
        cout << "error to open file" << endl;
    }
    fileptr.close();
}